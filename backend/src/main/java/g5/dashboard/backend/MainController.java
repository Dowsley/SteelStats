package g5.dashboard.backend;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import java.util.*;

@RestController // This means that this class is a Controller
@CrossOrigin(origins = "*")
public class MainController {
  // This means to get the bean called recordRepository
  // Which is auto-generated by Spring, we will use it to handle the data
  @Autowired
  private RecordRepository recordRepository;
  
  @Autowired
  private PerdaRepository perdaRepository;

  /* ***************************** */
  /* CALCULOS DE EVENTO DE MAQUINA */
  /* ***************************** */

  @GetMapping("/oees/{cod}")
  public ApiEquipmentResponse equipamentoOeeAnual(@PathVariable String cod) {
    Iterable<Integer> anosAtivos = recordRepository.getAnosAtivos(cod);

    Map<Integer, Double> oeeAnual = new HashMap<Integer, Double>();
    for (Integer ano : anosAtivos) {
      oeeAnual.put(
        ano,
        recordRepository.getDisponibilidade(cod, ano, null, null) *
        recordRepository.getQualidade(cod, ano, null, null) *
        recordRepository.getPerformance(cod, ano, null, null) * 100
      );
    }
    
    ApiEquipmentResponse response = new ApiEquipmentResponse();
    response.setEquipmentName(cod);
    response.setOees(oeeAnual);
    return response;
  }  

  @GetMapping({"/performance/{cod}", "/performance"})
  public Double calculoPerformance(@PathVariable Optional<String> cod,
                                   @RequestParam Optional<Integer> ano, 
                                   @RequestParam Optional<Integer> mes,
                                   @RequestParam Optional<Integer> dia) {
    Double calculo = recordRepository.getPerformance(
      cod.orElse(null),
      ano.orElse(null),
      mes.orElse(null),
      dia.orElse(null)
    );
    return calculo;
  }

  @GetMapping({"/qualidade/{cod}", "/qualidade"})
  public Double calculoQualidade(@PathVariable Optional<String> cod,
                                 @RequestParam Optional<Integer> ano, 
                                 @RequestParam Optional<Integer> mes,
                                 @RequestParam Optional<Integer> dia) {
    Double calculo = recordRepository.getQualidade(
      cod.orElse(null),
      ano.orElse(null),
      mes.orElse(null),
      dia.orElse(null)
    );
    return calculo;
  }

  @GetMapping({"/disponibilidade/{cod}", "/disponibilidade"})
  public Double calculoDisponibilidade(@PathVariable Optional<String> cod,
                                  @RequestParam Optional<Integer> ano, 
                                  @RequestParam Optional<Integer> mes,
                                  @RequestParam Optional<Integer> dia) {
    Double calculo = recordRepository.getDisponibilidade(
      cod.orElse(null),
      ano.orElse(null),
      mes.orElse(null),
      dia.orElse(null)
    );
    return calculo;
  }

  /* ************************** */
  /* CALCULOS DE PERDAS DA √ÅREA */
  /* ************************** */

  @GetMapping({"/perda/{tipo}", "/perda"})
  public Double calculoPerda(@PathVariable Optional<String> tipo,
                             @RequestParam Optional<Integer> ano, 
                             @RequestParam Optional<Integer> mes,
                             @RequestParam Optional<Integer> dia) {
    Double calculo = perdaRepository.getParada(
      tipo.orElse(null),
      ano.orElse(null),
      mes.orElse(null),
      dia.orElse(null)
    );
    return calculo;
  }
}